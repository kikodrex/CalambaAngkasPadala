<!DOCTYPE html>
<html lang="en">
<head>
    <title>Driver Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./libs/leaflet.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        .panel { padding: 15px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        #map { flex-grow: 1; z-index: 500; }
        h1 { margin: 0 0 15px 0; font-size: 1.5em; color: #333; }
        #status-card { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fafafa; }
        button { font-size: 1.2rem; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; transition: background-color 0.2s; width: 100%; }
        .online { background-color: #ef4444; }
        .offline { background-color: #22c55e; }
        .accept-btn { background-color: #3b82f6; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="panel">
        <h1>Driver Control Panel</h1>
        <button id="toggle-online-btn" class="offline">Go Online</button>
        <div id="status-card">
            <p><strong>Status:</strong> You are OFFLINE.</p>
        </div>
    </div>
    <div id="map"></div>

    <script src="./libs/leaflet.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const PUSHER_KEY = "2145cc5c326a430b3ffa"; // <-- PASTE YOUR PUBLIC KEY HERE
        const PUSHER_CLUSTER = "ap1";
        // In a real app, the driverId would come from a login system.
        const DRIVER_ID = `driver_${Math.floor(1000 + Math.random() * 9000)}`;
        
        // --- DOM ELEMENTS ---
        const toggleBtn = document.getElementById('toggle-online-btn');
        const statusCard = document.getElementById('status-card');
        
        // --- APP STATE ---
        let isOnline = false;
        let locationInterval = null;
        let myMarker = null;

        // --- MAP INITIALIZATION ---
        const map = L.map('map').setView([14.21, 121.16], 13); // Default view
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);

        // --- PUSHER SETUP ---
        if (!PUSHER_KEY || PUSHER_KEY === "YOUR_PUBLIC_PUSHER_KEY") {
            statusCard.innerHTML = '<strong style="color: red;">ERROR: Pusher Key is not set in driver.html.</strong>';
        } else {
            const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
            // This driver listens on a channel that receives ALL booking requests.
            // A real app would target drivers specifically.
            const channel = pusher.subscribe('booking-channel'); 
            
            channel.bind('new-ride-request', function(data) {
                if (!isOnline) return; // Ignore if offline

                statusCard.innerHTML = `
                    <p><strong>Incoming Ride Request!</strong></p>
                    <p>From: ${data.pickup.address}</p>
                    <p>To: ${data.destination.address}</p>
                    <button class="accept-btn" onclick="acceptRide('${data.bookingId}')">Accept Ride</button>
                `;
            });
        }
        
        // --- CORE FUNCTIONS ---
        function updateStatusOnServer(newStatus, location) {
            fetch('/api/driver-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ driverId: DRIVER_ID, status: newStatus, location })
            }).catch(error => console.error('Failed to update status on server:', error));
        }

        function startBroadcastingLocation() {
            if (locationInterval) clearInterval(locationInterval); // Clear any existing interval
            
            locationInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(position => {
                    const location = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };

                    // Update the server with current location
                    updateStatusOnServer('online', location);

                    // Update the driver's own map
                    const latLng = [location.lat, location.lon];
                    if (myMarker) {
                        myMarker.setLatLng(latLng);
                    } else {
                        myMarker = L.marker(latLng).addTo(map);
                    }
                    map.panTo(latLng); // Center map on driver

                }, (error) => console.error("Geolocation error:", error));
            }, 10000); // Update every 10 seconds
        }

        function stopBroadcastingLocation() {
            if (locationInterval) clearInterval(locationInterval);
            locationInterval = null;
            updateStatusOnServer('offline', null);
        }

        window.acceptRide = async function(bookingId) {
            statusCard.textContent = "Accepting ride...";
            try {
                const response = await fetch('/api/accept-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bookingId, driverId: DRIVER_ID })
                });
                if (!response.ok) throw new Error("Failed to accept booking.");
                statusCard.innerHTML = `<p><strong>Ride Accepted!</strong><br>Navigate to the pickup location.</p>`;
            } catch (error) {
                console.error("Accept ride error:", error);
                statusCard.textContent = "Error accepting ride.";
            }
        }

        // --- EVENT LISTENERS ---
        toggleBtn.addEventListener('click', () => {
            isOnline = !isOnline;
            toggleBtn.textContent = isOnline ? 'Go Offline' : 'Go Online';
            toggleBtn.className = isOnline ? 'online' : 'offline';
            
            if (isOnline) {
                statusCard.innerHTML = `<p><strong>ID:</strong> ${DRIVER_ID}</p><p><strong>Status:</strong> You are ONLINE.</p><p>Getting your location...</p>`;
                startBroadcastingLocation();
            } else {
                statusCard.innerHTML = `<p><strong>ID:</strong> ${DRIVER_ID}</p><p><strong>Status:</strong> You are OFFLINE.</p>`;
                stopBroadcastingLocation();
                if (myMarker) map.removeLayer(myMarker);
                myMarker = null;
            }
        });

    </script>
</body>
</html>
