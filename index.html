<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PH Angkas Padala - Functional Demo</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Reset & base */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html, body, #app {
    height: 100%;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #facc15, #dc2626); /* Yellow to Red gradient */
    color: #1e293b;
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Header */
  header {
    background: linear-gradient(135deg, #dc2626, #fbbf24); /* Red to Yellow gradient */
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    font-size: 1.5rem;
    position: sticky;
    top: 0;
    z-index: 10000;
    box-shadow: 0 4px 12px rgb(220 38 38 / 0.4);
  }

  header .logo {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  header .logo i.material-icons {
    font-size: 2rem;
  }

  /* Main container */
  #app {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    margin-bottom: 24px;
  }

  /* Responsive layout */
  main {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 16px;
  }

  @media(min-width: 768px) {
    main {
      flex-direction: row;
      padding: 24px 48px;
    }
  }

  /* Map container */
  #map {
    flex-grow: 1;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    min-height: 320px;
    touch-action: none;
  }

  /* Booking panel */
  #booking-panel {
    background: rgba(255 255 255 / 0.95);
    border-radius: 16px;
    padding: 24px;
    max-width: 400px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  #booking-panel h2 {
    font-weight: 700;
    font-size: 1.5rem;
    color: #dc2626; /* red */
    margin-bottom: 8px;
  }
  
  #booking-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  label {
    font-weight: 600;
    margin-bottom: -12px; /* Adjust spacing */
    color: #334155;
  }

  input {
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid #cbd5e1;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    width: 100%;
  }

  input:focus {
    outline: none;
    border-color: #fbbf24; /* yellow */
    box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
  }

  .pickup-container {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  button {
    background: #fbbf24; /* yellow */
    color: #dc2626; /* red */
    border: none;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(251,191,36,0.6);
    transition: background 0.3s ease, color 0.3s ease;
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 1rem;
    user-select: none;
  }

  button:hover:not(:disabled) {
    background: #dc2626; /* red */
    color: white;
  }

  button:disabled {
    background: #fcd34d; /* lighter yellow */
    cursor: not-allowed;
    box-shadow: none;
    color: #a16207; /* dark yellow/brown */
  }

  #book-btn {
    width: 100%;
  }

  #use-location-btn {
    min-width: 44px;
    padding: 0 12px;
    background: #dc2626;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
  }
  
  #use-location-btn:disabled {
    background: #f87171;
    cursor: not-allowed;
  }

  #use-location-btn i.material-icons {
    font-size: 24px;
  }

  #status {
    font-size: 1rem;
    color: #334155;
    font-weight: 600;
    min-height: 24px;
    min-width: 100%;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .leaflet-container {
    background: #fef3c7;
  }

  .autocomplete-items {
    position: absolute;
    border: 1px solid #cbd5e1;
    z-index: 9999;
    max-height: 180px;
    overflow-y: auto;
    border-radius: 8px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.15);
    background-color: #fff;
    left: 0;
    right: 0;
    margin-top: 4px;
  }

  .autocomplete-items div {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.95rem;
    color: #334155;
    border-bottom: 1px solid #f1f5f9;
  }

  .autocomplete-items div:last-child {
    border-bottom: none;
  }

  .autocomplete-items div:hover,
  .autocomplete-items .autocomplete-active {
    background-color: #dc2626;
    color: #fff;
  }

  #booking-confirmation-modal > div {
    animation: fadeInScale 0.3s ease-out;
  }

  @keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  #modal-cancel-btn:hover {
    background: #b91c1c !important;
  }

  footer {
    text-align: center;
    padding: 12px 24px;
    font-size: 0.9rem;
    color: #b91c1c;
  }
</style>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  integrity="sha256-sA+9twHpae04gjnyh/9FbriBhd3zox5dD+4ypCsXPsM="
  crossorigin=""
/>
</head>
<body>
<header>
  <div class="logo"><i class="material-icons" aria-hidden="true">motorcycle</i> PH Angkas Padala</div>
</header>
<div id="app">
  <main>
    <section id="map" aria-label="Map showing available drivers and routes" tabindex="0"></section>
    <section id="booking-panel" aria-label="Booking panel">
      <h2>Book a Ride</h2>

      <form id="booking-form" aria-describedby="status" novalidate autocomplete="off">
        <label for="pickup">Pick-up Location</label>
        <div class="pickup-container">
          <input type="text" id="pickup" name="pickup" placeholder="Enter pick-up address" autocomplete="off" aria-label="Pick-up location" />
          <button type="button" id="use-location-btn" aria-label="Use Current Location" title="Use Current Location"><i class="material-icons" aria-hidden="true">my_location</i></button>
        </div>
        
        <label for="destination">Destination</label>
        <input type="text" id="destination" name="destination" placeholder="Enter destination address" autocomplete="off" aria-label="Destination location" />
        
        <button type="submit" id="book-btn" disabled>Book Now</button>
      </form>

      <div id="status" aria-live="polite" role="region" aria-atomic="true"></div>
    </section>
  </main>
</div>

<div id="booking-confirmation-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100000; display:none; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.3); max-width:450px; width:90%; text-align:center; position:relative;">
    <h3 style="color:#dc2626; margin-bottom:20px; font-size:1.6rem;">Confirm Your Ride</h3>
    <p style="margin-bottom:10px; font-weight:600; color:#334155;">From: <span id="modal-pickup-address" style="font-weight:normal;"></span></p>
    <p style="margin-bottom:20px; font-weight:600; color:#334155;">To: <span id="modal-destination-address" style="font-weight:normal;"></span></p>
    <p style="font-size:1.8rem; font-weight:700; color:#fbbf24; margin-bottom:30px;">Estimated Fare: <span id="modal-fare">₱0.00</span></p>
    <div style="display:flex; justify-content:space-around; gap:15px;">
      <button id="modal-confirm-btn" style="flex:1; background:#dc2626; color:white; padding:12px 20px;">Confirm & Book</button>
      <button id="modal-cancel-btn" style="flex:1; background:#ef4444; color:white; padding:12px 20px;">Cancel</button>
    </div>
    <button id="modal-close-btn" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; color:#6b7280; cursor:pointer;" aria-label="Close modal">&times;</button>
  </div>
</div>

<footer>© 2024 PH Angkas Padala - Demo Only</footer>

<script
  src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
  integrity="sha256-oUvHa+gqfPtTHwSCDL0m2Cik/mQ9N6jX1tGEMx4x4uc="
  crossorigin=""
></script>

<script>
  (function(){
    "use strict";

    // --- CONFIGURATION ---
    // The backend server URL. You will need to build this server.
    const API_BASE_URL = "http://localhost:3000/api"; // Example for local development
    
    // Pricing is now handled by the server, but we keep these for fare estimates if needed.
    const BASE_FARE = 60.00;
    const SUCCEEDING_KM_RATE = 10.00;
    const PER_MINUTE_RATE = 2.00;
    const MINIMUM_FARE = 60.00;
    const INITIAL_KM_COVERED = 2.0;

    // --- MAP INITIALIZATION ---
    const map = L.map("map", {
      center: [12.8797, 121.7740],
      zoom: 6,
      zoomControl: true,
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors',
    }).addTo(map);

    // --- DOM ELEMENTS ---
    const pickupInput = document.getElementById("pickup");
    const destinationInput = document.getElementById("destination");
    const bookBtn = document.getElementById("book-btn");
    const bookingForm = document.getElementById("booking-form");
    const useLocationBtn = document.getElementById("use-location-btn");
    const statusEl = document.getElementById("status");
    const modal = document.getElementById("booking-confirmation-modal");
    const modalPickupAddress = document.getElementById("modal-pickup-address");
    const modalDestinationAddress = document.getElementById("modal-destination-address");
    const modalFare = document.getElementById("modal-fare");
    const modalConfirmBtn = document.getElementById("modal-confirm-btn");
    const modalCancelBtn = document.getElementById("modal-cancel-btn");
    const modalCloseBtn = document.getElementById("modal-close-btn");

    // --- APP STATE & VARIABLES ---
    let pickupLatLng = null;
    let destinationLatLng = null;
    let routeLayer = null;
    let userMarkers = [];
    let driverMarkers = {}; // Use an object to easily update driver markers by ID
    let estimatedFareGlobal = 0;
    
    const driverIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2972/2972185.png",
      iconSize: [36, 36],
      iconAnchor: [18, 36]
    });

    // --- INITIALIZE THE APP ---
    initBookingFeatures();
    
    // Start fetching driver locations periodically
    setInterval(fetchAvailableDrivers, 5000); // Fetch every 5 seconds

    // =================================================================
    // NEW FUNCTION: Fetch available drivers from the backend
    // This replaces the old `createSimulatedDrivers`
    // =================================================================
    async function fetchAvailableDrivers() {
        try {
            // Your backend should have an endpoint like this
            const response = await fetch(`${API_BASE_URL}/drivers/available`);
            if (!response.ok) {
                console.error("Failed to fetch drivers");
                return;
            }
            const drivers = await response.json(); // e.g., [{ id: 'driver1', lat: 14.2, lon: 121.1 }]
            
            updateDriverMarkers(drivers);

        } catch (error) {
            console.error("Error fetching drivers:", error);
        }
    }

    // =================================================================
    // NEW FUNCTION: Update driver markers on the map
    // This shows the real-time locations received from the server
    // =================================================================
    function updateDriverMarkers(drivers) {
        const existingDriverIds = Object.keys(driverMarkers);
        const incomingDriverIds = drivers.map(d => d.id);

        // Add or update markers
        drivers.forEach(driver => {
            const latLng = [driver.lat, driver.lon];
            if (driverMarkers[driver.id]) {
                // Driver exists, just move the marker
                driverMarkers[driver.id].setLatLng(latLng);
            } else {
                // New driver, create a new marker
                driverMarkers[driver.id] = L.marker(latLng, { icon: driverIcon }).addTo(map)
                    .bindPopup(`Driver ${driver.id}`);
            }
        });

        // Remove markers for drivers who are no longer available
        existingDriverIds.forEach(id => {
            if (!incomingDriverIds.includes(id)) {
                map.removeLayer(driverMarkers[id]);
                delete driverMarkers[id];
            }
        });
    }

    function initBookingFeatures() {
      // Event listeners for UI elements
      useLocationBtn.addEventListener('click', handleUseLocation);
      bookingForm.addEventListener("submit", handleFormSubmit);
      modalConfirmBtn.addEventListener("click", handleConfirmBooking);
      modalCancelBtn.addEventListener("click", () => modal.style.display = "none");
      modalCloseBtn.addEventListener("click", () => modal.style.display = "none");

      // Setup autocomplete for address inputs
      setAutocomplete(pickupInput);
      setAutocomplete(destinationInput);
    }
    
    // =================================================================
    // REFACTORED: Booking confirmation now sends data to the server
    // This replaces the old `setTimeout` simulation
    // =================================================================
    async function handleConfirmBooking() {
        updateStatus("Requesting your ride...");
        modalConfirmBtn.disabled = true;

        const bookingDetails = {
            pickup: { address: pickupInput.value, lat: pickupLatLng[0], lon: pickupLatLng[1] },
            destination: { address: destinationInput.value, lat: destinationLatLng[0], lon: destinationLatLng[1] },
            estimatedFare: estimatedFareGlobal
            // In a real app, you'd also send a user authentication token
        };

        try {
            // Your backend should have an endpoint like POST /api/bookings
            const response = await fetch(`${API_BASE_URL}/bookings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingDetails)
            });

            if (!response.ok) {
                // Handle server errors (e.g., no available drivers)
                const errorData = await response.json();
                throw new Error(errorData.message || "Booking failed.");
            }

            const result = await response.json(); // e.g., { bookingId: 'xyz', status: 'searching' }
            updateStatus(`Booking created! Searching for a driver... (ID: ${result.bookingId})`);
            
            // Here you would use WebSockets to listen for booking status updates
            // e.g., listen for "driver-accepted", "driver-en-route", etc.

        } catch (error) {
            updateStatus(`Error: ${error.message}`);
        } finally {
            modal.style.display = "none";
            modalConfirmBtn.disabled = false;
        }
    }

    // --- Other UI and Map Functions (Largely unchanged) ---

    function handleUseLocation() {
        // ... unchanged geolocation logic ...
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        if (!pickupLatLng || !destinationLatLng) {
          updateStatus("Please select both pick-up and destination.");
          return;
        }
        modalPickupAddress.textContent = pickupInput.value;
        modalDestinationAddress.textContent = destinationInput.value;
        modalFare.textContent = estimatedFareGlobal ? `₱${estimatedFareGlobal.toFixed(2)}` : "Calculating...";
        modal.style.display = "flex";
        bookBtn.disabled = true;
    }

    function fetchRoute(start, end) {
        const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
        updateStatus("Calculating route and fare...");
        fetch(url)
            .then((res) => res.json())
            .then((data) => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coords = route.geometry.coordinates.map((c) => [c[1], c[0]]);
                    if(routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.polyline(coords, { color: "#dc2626", weight: 5, opacity: 0.8 }).addTo(map);
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

                    const distanceKm = route.distance / 1000;
                    const durationMinutes = route.duration / 60;

                    let distanceFare = 0;
                    if (distanceKm > INITIAL_KM_COVERED) {
                        distanceFare = (distanceKm - INITIAL_KM_COVERED) * SUCCEEDING_KM_RATE;
                    }
                    const timeFare = durationMinutes * PER_MINUTE_RATE;
                    let estimatedFare = BASE_FARE + distanceFare + timeFare;
                    estimatedFare = Math.max(estimatedFare, MINIMUM_FARE);
                    estimatedFare = Math.round(estimatedFare / 5) * 5;

                    estimatedFareGlobal = estimatedFare;

                    updateStatus(
                        `Route: ${distanceKm.toFixed(2)} km, approx. ${durationMinutes.toFixed(0)} mins. Estimated Fare: ₱${estimatedFare.toFixed(2)}`
                    );
                } else {
                    updateStatus("Unable to find route.");
                }
            })
            .catch(() => {
                updateStatus("Route service is unavailable.");
            });
    }
    
    // Functions like setAutocomplete, updateStatus, etc. remain the same
    function setAutocomplete(inputElem) { /* ... unchanged ... */ }
    function updateStatus(message) { statusEl.textContent = message; }
    function updateBookingButton() { bookBtn.disabled = !(pickupLatLng && destinationLatLng); }
    // ... all other helper functions ...

  })();
</script>

</body>
</html>
