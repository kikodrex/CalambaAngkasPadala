<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ride Booking App</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./libs/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --primary-color: #3b82f6; --secondary-color: #fbbf24; --success-color: #22c55e; --danger-color: #ef4444; --info-color: #3b82f6; --grey-light: #f3f4f6; --grey-dark: #4b5563; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; background-color: var(--grey-light); }
        #booking-panel { width: 380px; display: flex; flex-direction: column; padding: 20px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1); z-index: 1000; }
        #map { flex-grow: 1; z-index: 500; }
        h1 { display: flex; align-items: center; gap: 10px; margin: 0 0 20px 0; font-size: 1.8em; color: var(--primary-color); }
        .card { border: 1px solid #e5e7eb; margin-top: 20px; padding: 15px; border-radius: 8px; background: #fafafa; }
        .card h2 { margin: 0 0 10px 0; font-size: 1.1em; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--grey-dark); }
        .form-group input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1em;
        }
        button { font-size: 1.2rem; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; background-color: var(--primary-color); }
        button:hover { opacity: 0.9; }
        #status-message { margin-top: 20px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 500; display: none; }
        #status-message.success { background-color: #d1fae5; color: var(--success-color); }
        #status-message.error { background-color: #fee2e2; color: var(--danger-color); }
        #status-message.info { background-color: #dbeafe; color: var(--info-color); } /* Added info styling */

        @media (max-width: 768px) { body { flex-direction: column; } #booking-panel { width: 100%; height: 40%; overflow-y: auto; box-sizing: border-box; } }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="booking-panel">
        <h1><i class="material-icons">directions_car</i>Book a Ride</h1>

        <div class="form-group">
            <label for="pickup-address">Pickup Location:</label>
            <input type="text" id="pickup-address" placeholder="Enter pickup address">
        </div>
        <div class="form-group">
            <label for="destination-address">Destination:</label>
            <input type="text" id="destination-address" placeholder="Enter destination address">
        </div>

        <button id="request-ride-btn"><i class="material-icons">send</i>Request Ride</button>

        <div id="status-message"></div>

        <div id="location-status" class="card">
            <h2>Your Location</h2>
            <p><strong>Latitude:</strong> <span id="current-lat">N/A</span></p>
            <p><strong>Longitude:</strong> <span id="current-lon">N/A</span></p>
            <p id="location-error" style="color: var(--danger-color);"></p>
        </div>
    </div>

    <script src="./libs/leaflet.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>
        // --- CONFIGURATION ---
        const PUSHER_KEY = "YOUR_PUBLIC_PUSHER_KEY"; // <-- PASTE YOUR PUBLIC KEY HERE (Same as Driver's)
        const PUSHER_CLUSTER = "ap1";

        // --- DOM ELEMENTS ---
        const requestRideBtn = document.getElementById('request-ride-btn');
        const pickupAddressInput = document.getElementById('pickup-address');
        const destinationAddressInput = document.getElementById('destination-address');
        const statusMessageEl = document.getElementById('status-message');
        const currentLatEl = document.getElementById('current-lat');
        const currentLonEl = document.getElementById('current-lon');
        const locationErrorEl = document.getElementById('location-error');

        // --- APP STATE ---
        let userMarker = null;
        let userLocation = null; // { lat, lon }

        // --- MAP INITIALIZATION ---
        const map = L.map('map').setView([12.8797, 121.7740], 6); // Default view for Philippines
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);

        // --- GEOLOCATION ---
        function getUserLocation() {
            if (navigator.geolocation) {
                locationErrorEl.textContent = "Attempting to get your location..."; // Indicate loading
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        currentLatEl.textContent = userLocation.lat.toFixed(5);
                        currentLonEl.textContent = userLocation.lon.toFixed(5);
                        map.setView([userLocation.lat, userLocation.lon], 15); // Zoom to user's location

                        if (userMarker) {
                            userMarker.setLatLng([userLocation.lat, userLocation.lon]);
                        } else {
                            userMarker = L.marker([userLocation.lat, userLocation.lon], {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                                })
                            }).addTo(map).bindPopup("You are here!").openPopup();
                        }
                        locationErrorEl.textContent = ""; // Clear any previous error
                        // Automatically fill pickup address if desired or just display location
                        pickupAddressInput.value = "Current Location"; // Placeholder or actual reverse geocoded address
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let errorMessage = "Unable to retrieve your location.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += " Please allow location access for this page.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += " Location information is unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage += " The request to get user location timed out.";
                                break;
                            default:
                                errorMessage += ` Error code: ${error.code}`;
                        }
                        locationErrorEl.textContent = errorMessage;
                        map.setView([12.8797, 121.7740], 6); // Fallback to default view
                        userLocation = null; // Ensure userLocation is null on error
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                locationErrorEl.textContent = "Geolocation is not supported by your browser.";
                map.setView([12.8797, 121.7740], 6); // Fallback to default view
                userLocation = null; // Ensure userLocation is null if not supported
            }
        }
        getUserLocation(); // Get location on page load

        // --- RIDE REQUEST FUNCTION ---
        requestRideBtn.addEventListener('click', async () => {
            const pickupAddress = pickupAddressInput.value.trim();
            const destinationAddress = destinationAddressInput.value.trim();

            // --- Robust Input Validation ---
            if (!pickupAddress) {
                displayStatusMessage("Please enter a pickup address.", "error");
                return;
            }
            if (!destinationAddress) {
                displayStatusMessage("Please enter a destination address.", "error");
                return;
            }
            if (!userLocation || !userLocation.lat || !userLocation.lon) {
                displayStatusMessage("Your current location is not available. Please allow location access and ensure it loads.", "error");
                // Attempt to get location again if it failed
                getUserLocation();
                return;
            }

            // In a real app, you'd geocode these addresses to get lat/lon if they're not 'Current Location'
            // For now, we'll use userLocation for pickup and dummy for destination
            const rideRequestData = {
                bookingId: `booking_${Date.now()}_${Math.floor(Math.random() * 90000) + 10000}`, // More unique ID
                pickup: {
                    address: pickupAddress,
                    lat: userLocation.lat,
                    lon: userLocation.lon
                },
                destination: {
                    address: destinationAddress,
                    // These would ideally come from geocoding the destination address
                    // Using dummy coordinates for now, relative to user's location for variety
                    lat: userLocation.lat + (Math.random() - 0.5) * 0.2,
                    lon: userLocation.lon + (Math.random() - 0.5) * 0.2
                },
                riderId: `rider_${Math.floor(1000 + Math.random() * 9000)}`, // Dummy rider ID
                distance: (Math.random() * 20 + 5).toFixed(1), // Dummy distance between 5-25km
                fare: (Math.random() * 200 + 100).toFixed(2) // Dummy fare between 100-300 PHP
            };

            // --- DEBUGGING LOGS ---
            console.log("Frontend: Sending ride request with bookingId:", rideRequestData.bookingId);
            console.log("Frontend: Full rideRequestData being sent:", JSON.stringify(rideRequestData));
            // --- END DEBUGGING LOGS ---

            displayStatusMessage("Requesting ride...", "info");
            requestRideBtn.disabled = true; // Disable button to prevent multiple requests

            try {
                const response = await fetch('/api/request-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rideRequestData)
                });

                const result = await response.json(); // Attempt to parse JSON response

                if (response.ok) {
                    displayStatusMessage(`Ride requested! Booking ID: ${result.bookingId || rideRequestData.bookingId}. Looking for drivers...`, "success");
                    // In a real app, you'd now listen to a Pusher channel specific to this booking ID
                    // pusher.subscribe(`booking-${result.bookingId}`).bind('driver-assigned', handleDriverAssigned);
                } else {
                    // Log the error from the backend response if available
                    console.error("Backend Error Response:", result);
                    throw new Error(result.message || 'Failed to request ride.');
                }
            } catch (error) {
                console.error("Ride request error:", error);
                displayStatusMessage(`Error requesting ride: ${error.message || error}`, "error");
            } finally {
                requestRideBtn.disabled = false;
            }
        });

        // --- Helper for Status Messages ---
        function displayStatusMessage(message, type) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `card ${type}`; // Apply type for styling (success, error, info)
            statusMessageEl.style.display = 'block';

            // Optional: Hide after some time for non-critical messages
            if (type !== 'info') { // Keep info messages (like "Looking for drivers") visible
                setTimeout(() => {
                    statusMessageEl.style.display = 'none';
                }, 5000);
            }
        }

        // --- Pusher for real-time updates (optional for this simple frontend, but good practice) ---
        // This frontend could subscribe to its own unique channel (e.g., based on riderId or bookingId)
        // to receive updates like "driver assigned", "driver arrived", etc.
        /*
        const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
        // Example of a personal rider channel (requires backend to authenticate and send to it)
        // const riderChannel = pusher.subscribe(`private-rider-${RIDER_ID}`);
        // riderChannel.bind('driver-assigned', function(data) {
        //     displayStatusMessage(`Driver ${data.driverId} assigned!`, 'success');
        //     // Update map to show driver location etc.
        // });
        */
    </script>
</body>
</html>
